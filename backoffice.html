<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gli Stockisti</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <style>
      .navbar-nav .nav-link.active,
      .navbar-nav .nav-link.show {
        --bs-nav-link-font-weight: 600;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-sm bg-body-tertiary">
      <div class="container-md">
        <a class="navbar-brand" href="#">EPIGENDA</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="./index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="./backoffice.html">Backoffice</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container-md">
      <div class="row justify-content-center">
        <div class="col-8">
          <div class="my-4">
            <h2 class="display-4 d-inline-block">Backoffice</h2>
            <h5 id="subtitle" class="d-inline-block"></h5>
            <div class="spinner-border text-primary fs-6" role="status">
              <span class="visually-hidden">Caricamento...</span>
            </div>
          </div>

          <hr />
          <div id="alert-box"></div>
          <form onsubmit="invioForm(event)">
            <div>
              <label for="imageUrl" class="form-label">URL dell'immagine:</label>
              <input type="text" class="form-control" id="imageUrl" placeholder="Inserisci il link della image" />
            </div>
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" placeholder="Inserisci il nome del prodotto" required />
            </div>
            <div class="mb-3">
              <label for="brand" class="form-label">Brand</label>
              <input
                type="text"
                class="form-control"
                id="brand"
                placeholder="Aggiungi il modello del prodotto"
                required
              />
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea
                type="text"
                class="form-control"
                id="description"
                placeholder="Inserisci la descrizione"
                required
              ></textarea>
            </div>
            <div class="mb-3">
              <label for="price" class="form-label">Price</label>
              <input type="number" class="form-control" id="price" placeholder="â‚¬" />
            </div>

            <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-primary">Aggiungi Prodotto</button>
              <button type="reset" class="btn btn-secondary">Reset</button>
              <button type="button" class="btn btn-danger d-none" onclick="ripulisciForm()">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-trash3"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"
                  />
                </svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script>
      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NTczNjhmN2ZlMDMxZTAwMTliYTFhZjkiLCJpYXQiOjE3MDIwNjIzMjcsImV4cCI6MTcwMzI3MTkyN30.EVQsdJk2CjupWU7y6wz1FU8Y2yfUvBBWF4CQMDzs5Vg";
      const reqHeader = {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      };
      const isLoading = (boolean) => {
        const spinner = document.querySelector(".spinner-border");

        if (boolean) {
          spinner.classList.remove("d-none");
        } else {
          spinner.classList.add("d-none");
        }
      };
      /*const reqHeader = {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      };*/
      const resourceId = new URLSearchParams(window.location.search).get("resourceId");
      console.log("RESOURCE ID: ", resourceId);
      let URL;
      let metodo;

      if (resourceId) {
        URL = "https://striveschool-api.herokuapp.com/api/product/" + resourceId;
        metodo = "PUT";
      } else {
        URL = "https://striveschool-api.herokuapp.com/api/product/";
        metodo = "POST";
        isLoading(false);
      }
      console.log(URL);
      console.log(metodo);

      window.addEventListener("DOMContentLoaded", () => {
        const submitBtn = document.querySelector("button[type='submit']");
        const deleteBtn = document.querySelector("button[type='button'].btn-danger");
        const resetBtn = document.querySelector("button[type='reset']");
        const subtitle = document.getElementById("subtitle");

        if (resourceId) {
          subtitle.innerText = "- Modifica Prodotto";

          submitBtn.classList.remove("btn-primary");
          submitBtn.classList.add("btn-success");
          submitBtn.innerText = "Modifica prodotto";

          deleteBtn.classList.remove("d-none");

          fetch(URL, reqHeader)
            .then((resp) => resp.json())
            .then(({ name, brand, description, price, imageUrl }) => {
              document.getElementById("name").value = name;
              document.getElementById("brand").value = brand;
              document.getElementById("description").value = description;
              document.getElementById("price").value = price;
              document.getElementById("imageUrl").value = imageUrl;
            })

            .finally(() => isLoading(false));
        } else {
          subtitle.innerText = "- Aggiugni Prodotto";
        }
      });

      const invioForm = (event) => {
        event.preventDefault();

        const form = event.target;

        const nuovoProdotto = {
          name: document.getElementById("name").value,
          description: document.getElementById("description").value,
          brand: document.getElementById("brand").value,
          imageUrl: document.getElementById("imageUrl").value,
          price: document.getElementById("price").value,
        };
        isLoading(true);
        console.log(nuovoProdotto);

        console.log(JSON.stringify(nuovoProdotto));

        fetch(URL, {
          method: metodo,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(nuovoProdotto),
        })
          .then((resp) => {
            if (!resp.ok) {
              console.log(resp);
              throw new Error("Errore nella creazione del prodotto");
            }
            return resp.json();
          })
          //console.log(resp)s

          .then((createdObj) => {
            const message = resourceId
              ? `Risorsa con id: ${createdObj._id} modificata con successo!`
              : `Risorsa con id: ${createdObj._id} creata con successo!`;

            showAlert(message, "success");

            resourceId || form.reset();
          })
          .finally(() => isLoading(false))

          .catch((error) => {
            console.error("Errore durante la  creazione del nuovo prodotto", error.message);
            if (error.resp) {
              error.resp.json().then((data) => {
                console.log("dettagli dell'errore:", data);
              });
            } else {
              console.log("Nessuna risposta dal server");
            }
          });
      };

      const showAlert = (message, colorCode = "primary") => {
        const alertBox = document.getElementById("alert-box");
        alertBox.innerHTML = `<div class="alert alert-${colorCode}" role="alert">
                                ${message}
                                </div>`;

        setTimeout(() => {
          alertBox.innerHTML = "";
        }, 2000);
      };

      const ripulisciForm = async () => {
        const conferma = confirm("Stai per eliminare il prodotto, sei sicuro?");

        if (conferma) {
          try {
            isLoading(true);
            const response = await fetch(URL, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            });

            if (!response.ok) {
              throw new Error("Errore durante l'eliminazione della risorsa");
            }

            const deletedObj = await response.json();
            showAlert(`Hai eliminato il prodotto ${deletedObj.name} che aveva id: ${deletedObj._id}`, "danger");

            // Utilizziamo await per aspettare il tempo desiderato prima del cambio pagina
            await new Promise((resolve) => setTimeout(resolve, 3000)).finally(() => {
              isLoading(false);
            });

            window.location.assign("./index.html");
          } catch (error) {
            console.error("Errore durante la gestione della risposta:", error);
          }
        }
      };
    </script>
  </body>
</html>
